重新部署k8s
参考：https://github.com/kubernetes-incubator/kubespray

1.  准备依赖的组件
参考https://github.com/gjmzj/kubeasz/blob/master/docs/setup/quickStart.md，把pip的源改成国内源

yum install epel-release –y


yum install git python-pip -y# pip安装ansible(国内如果安装太慢可以直接用pip阿里云加速)#pip install pip --upgrade#pip install ansible

pip install pip --upgrade -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com

pip install --no-cache-dir ansible -i http://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com

git clone https://github.com/kubernetes-incubator/kubespray

pip install -r requirements.txt
出现问题:Cannot uninstall 'requests'. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.
解决方法：pip install six --upgrade --ignore-installed six

由于镜像使用的是google的，需要翻墙才能下载，所以这里需要修改一些文件中的镜像地址，修改文件如下：
kubespray/roles/kubernetes-apps/ansible/defaults/main.yml
kubespray/roles/download/defaults/main.yml
kubespray/extra_playbooks/roles/download/defaults/main.yml
inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml
inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml

2. 执行部署
ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml

出现问题：ERROR! no action detected in task. This often indicates a misspelled module name, or incorrect module path.
原因及解决方法：requirements.txt安装时部分没有安装好，所以依赖没有解决，导致出现这个问题
检查了下，ansible-modules-hashivault没有安装，直接install会出问题，需要执行下面的命令
pip install ansible-modules-hashivault --upgrade --ignore-installed ansible-modules-hashivault

继续执行部署，出现错误，docker启动失败：
fatal: [node2]: FAILED! => {"changed": false, "msg": "Unable to start service docker: Job for docker.service failed because the control process exited with error code. See \"systemctl status docker.service\" and \"journalctl -xe\" for details.\n"}
fatal: [node3]: FAILED! => {"changed": false, "msg": "Unable to start service docker: Job for docker.service failed because the control process exited with error code. See \"systemctl status docker.service\" and \"journalctl -xe\" for details.\n"}
fatal: [node1]: FAILED! => {"changed": false, "msg": "Unable to start service docker: Job for docker.service failed because the control process exited with error code. See \"systemctl status docker.service\" and \"journalctl -xe\" for details.\n"}
查看日志：
Nov  9 02:47:42 x systemd: Cannot add dependency job for unit docker-storage-setup.service, ignoring: Unit not found.
Nov  9 02:47:42 x systemd: Starting Docker Application Container Engine...
Nov  9 02:47:42 x docker: unknown flag: --insecure-registry

原因：目前看起来是安装docker的选项出了问题，默认driver是devicemapper,使能了docker-storage，二devicemapper是需要lvm分区的，新建的虚拟机没有，所有docker启动失败。
解决方法：driver改用overlay2

建议：了解下docker的几种driver及大概原理，互相比较优缺点

由于overlay2的功能要求内核版本4.0以上，因此升级内核：
 在 CentOS 7 上启用 ELRepo 仓库
  rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
  rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
 列出可用的内核相关包：
  yum --disablerepo="*" --enablerepo="elrepo-kernel" list available
 安装内核：
  yum --enablerepo=elrepo-kernel install kernel-lt.x86_64

vim /etc/default/grub
GRUB_DEFAULT=0   #<==save改为0
grub2-mkconfig -o /boot/grub2/grub.cfg
重新启动

使用overlay2还是再docker启动部分失败，尝试加入了一个新节点，发现新节点成功了，怀疑老节点之前安装过其他版本docker的原因，有残余配置导致安装的新
版本的docker一直失败，尝试全部用新节点部署。新节点部署，docker安装成功。

docker安装过后，遇到镜像问题，因为镜像地址是国外google的，还是需要修改镜像地址。
将需要的镜像push到自己的阿里云仓库上，然后修改脚本中要替换的镜像地址。

使用aliyun镜像：
docker login --username=fantasticfee registry.cn-hangzhou.aliyuncs.com
需要替换的镜像：
pause-amd64
calico-ctl
cluster-proportional-autoscaler-amd64
hyperkube-amd64
k8s-dns-dnsmasq-nanny-amd64
k8s-dns-kube-dns-amd64
k8s-dns-sidecar-amd64
kube-registry-proxy
kubernetes-dashboard-amd64

继续部署，出现apiserver一直没有启动的情况
启动失败，查看日志docker logs,显示不识别选项。 
Error: unknown flag: --endpoint-reconciler-type
查看hyperkube 的版本，还是老版本，而reconciler是个新特性，解决方法，换个新版本的查看hyperkube。
更换新版本，apiserver果然恢复正常。




